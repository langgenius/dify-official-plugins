# OneDrive文档处理器配置指南

## 🎯 **文档处理器配置详解**

### 1. **在Dify Pipeline中的配置流程**

#### 步骤1：添加OneDrive数据源节点
```yaml
节点配置:
  节点名称: onedrive_source
  类型: 数据源 > OneDrive
  操作模式: 下载文件
  参数配置:
    file_id: "4C588C50361D50A3!857"  # 您的文件ID
```

#### 步骤2：添加文档处理器节点
```yaml
节点配置:
  节点名称: document_processor
  类型: 文档处理器
  输入源: {{onedrive_source.result}}
  
  处理参数:
    文本提取: 启用
    分块策略: 
      - 分块大小: 1000 字符
      - 重叠长度: 100 字符
      - 分隔符: 自动识别
    
    格式支持:
      - PDF: ✅ 支持
      - Word (.docx): ✅ 支持  
      - PowerPoint (.pptx): ✅ 支持
      - Excel (.xlsx): ✅ 支持
      - 纯文本 (.txt): ✅ 支持
      - Markdown (.md): ✅ 支持
```

## 🔧 **OneDrive文件下载操作**

### 方式1：通过文件ID直接下载
这是您当前使用的方式，最直接有效：

```javascript
// 在OneDrive数据源节点中配置
{
  "operation": "download_file",
  "file_id": "4C588C50361D50A3!857"
}
```

**操作步骤**：
1. 打开Dify Pipeline编辑器
2. 添加"OneDrive数据源"节点
3. 在节点配置中选择"下载文件"模式
4. 输入文件ID：`4C588C50361D50A3!857`
5. 保存配置

### 方式2：通过文件浏览器选择
如果您不知道文件ID，可以使用浏览模式：

```javascript
// 第一步：浏览文件
{
  "operation": "browse_files",
  "folder_path": "root"  // 或具体文件夹路径
}

// 第二步：选择文件下载
{
  "operation": "download_file", 
  "file_id": "{{从浏览结果中选择的文件ID}}"
}
```

## 📋 **Dify界面操作指南**

### 1. **添加OneDrive数据源节点**

**界面操作**：
1. 在Pipeline画布中点击 "+" 按钮
2. 选择 "数据源" → "OneDrive"
3. 节点会出现在画布上

**节点配置界面**：
```
┌─────────────────────────────────────┐
│ OneDrive数据源                       │
├─────────────────────────────────────┤
│ 节点名称: [onedrive_docs        ]   │
│ 操作模式: [下载文件 ▼]              │
│ 文件选择:                           │
│   ○ 输入文件ID                      │
│     文件ID: [4C588C50361D50A3!857] │
│   ○ 浏览选择文件                    │
│     [浏览文件...]                   │
└─────────────────────────────────────┘
```

### 2. **添加文档处理器节点**

**界面操作**：
1. 点击 "+" → "文档处理" → "文档加载器"
2. 将OneDrive节点连接到文档处理器

**文档处理器配置界面**：
```
┌─────────────────────────────────────┐
│ 文档处理器                           │
├─────────────────────────────────────┤
│ 节点名称: [doc_processor        ]   │
│ 输入源: [{{onedrive_docs.result}}] │
│                                     │
│ 文本提取设置:                        │
│ ✅ 启用文本提取                     │
│                                     │
│ 分块设置:                           │
│ 分块大小: [1000    ] 字符          │
│ 重叠长度: [100     ] 字符          │
│ 分隔符: [自动识别 ▼]               │
│                                     │
│ 清理设置:                           │
│ ✅ 移除多余空格                     │
│ ✅ 移除特殊字符                     │
│ □ 移除数字                         │
└─────────────────────────────────────┘
```

### 3. **添加知识库节点**

**配置示例**：
```
┌─────────────────────────────────────┐
│ 知识库                               │
├─────────────────────────────────────┤
│ 节点名称: [knowledge_base       ]   │
│ 文档源: [{{doc_processor.documents}}]│
│                                     │
│ 嵌入模型: [text-embedding-ada-002▼] │
│ 向量维度: [1536              ]     │
│                                     │
│ 索引设置:                           │
│ 索引名称: [onedrive_docs_index  ]   │
│ ✅ 启用语义搜索                     │
│ ✅ 启用关键词搜索                   │
└─────────────────────────────────────┘
```

## ⚙️ **高级配置选项**

### 文档处理器高级参数

#### 1. **文本提取配置**
```yaml
文本提取:
  OCR: 启用                    # 处理扫描PDF和图片
  表格提取: 启用               # 提取表格数据
  图片描述: 启用               # 生成图片描述
  公式识别: 启用               # 识别数学公式
```

#### 2. **分块策略配置**
```yaml
分块策略:
  方式: 语义分块               # 或 固定长度、段落分块
  最大长度: 1000              # 字符数
  最小长度: 100               # 避免过短片段
  重叠比例: 10%               # 重叠内容比例
```

#### 3. **文件格式处理**
```yaml
格式处理:
  PDF:
    密码保护: 支持输入密码
    页面范围: 指定处理页面
  
  Word:
    样式保持: 保留标题层级
    表格处理: 转换为结构化数据
    
  PowerPoint:
    备注提取: 包含演讲者备注
    动画忽略: 忽略动画效果
```

## 🎮 **实际操作演示**

### 完整操作流程

1. **创建Pipeline**
   ```
   工作台 → 创建应用 → Pipeline应用
   ```

2. **配置数据流**
   ```
   [OneDrive] → [文档处理器] → [知识库] → [LLM对话]
   ```

3. **设置变量传递**
   ```javascript
   OneDrive输出 → 文档处理器输入: {{onedrive_docs.result}}
   文档处理器输出 → 知识库输入: {{doc_processor.documents}}  
   知识库输出 → LLM输入: {{knowledge_base.context}}
   ```

4. **测试运行**
   ```
   点击"运行" → 查看每个节点输出 → 调试修正
   ```

## 🔍 **调试和监控**

### 查看节点输出

在Pipeline调试模式下：
```javascript
// OneDrive节点输出
{
  "file_content": "文件的二进制数据...",
  "meta": {
    "file_name": "document.pdf",
    "mime_type": "application/pdf",
    "size": 2048576
  }
}

// 文档处理器输出  
{
  "documents": [
    {
      "content": "提取的文本内容...",
      "metadata": {
        "source": "document.pdf",
        "page": 1,
        "chunk_id": "chunk_001"
      }
    }
  ]
}
```

### 常见问题排查

1. **文件下载失败**
   ```
   检查项:
   - 文件ID是否正确
   - OneDrive权限是否足够  
   - 网络连接是否稳定
   ```

2. **文档处理出错**
   ```
   检查项:
   - 文件格式是否支持
   - 文件是否损坏
   - 分块参数是否合理
   ```

3. **变量传递错误**
   ```
   检查项:
   - 节点名称是否正确
   - 变量路径是否完整
   - 数据格式是否匹配
   ```

## 💡 **最佳实践**

1. **节点命名**
   - 使用描述性名称：`onedrive_reports`、`pdf_processor`
   - 避免特殊字符和空格

2. **分块策略**
   - 技术文档：800-1200字符
   - 小说文本：1500-2000字符  
   - 表格数据：按行分块

3. **错误处理**
   - 添加条件节点检查文件存在性
   - 设置备用处理流程
   - 记录处理日志

4. **性能优化**
   - 大文件考虑分页处理
   - 批量操作时设置合理间隔
   - 使用缓存避免重复下载

通过以上配置，您就可以在Dify中完整实现OneDrive文件的自动下载和智能处理了！
