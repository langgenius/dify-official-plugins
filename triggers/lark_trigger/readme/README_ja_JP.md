# Lark Trigger プラグインユーザーガイド

## このプラグインの機能

Lark Triggerプラグインは、DifyワークフローをLark（Feishu）イベントと接続します。Larkワークスペースで何かが起こったとき - メッセージの受信、ファイルの作成、会議への参加など - このプラグインは自動的にDifyワークフローを開始してこれらのイベントに応答します。

## 始め方

### ステップ1：Larkアプリをセットアップ

1. [Lark Open Platform](https://open.larksuite.com/)にアクセスして新しいアプリを作成します
2. アプリ設定で、次の4つの情報を見つけて保存します：
   - **App Credentials**: `Credentials & Basic Info`セクションで見つけることができます
      - **App ID**: アプリの一意の識別子
      - **App Secret**: アプリのパスワード（安全に保管してください！）
   - **Event Subscriptions**: `Events & Callbacks`セクションで見つけることができます
      - **Encrypt Key**: イベントデータを暗号化するために使用されます。Larkではオプションですが、このプラグインでは必須です
      - **Verification Token**: イベントが本当にLarkからのものであることを確認するために使用されます

![Lark App Credentials](./_assets/ca5d4697947a8a42ca7c9cb132317525.png)
![Lark Event Subscriptions](./_assets/a5aca5b287802de21726742f702d89f2.png)

### ステップ2：LarkとDifyの両方でイベントサブスクリプションを設定

1. Difyプラグインページに戻り、「Lark Trigger」プラグインを見つけます。プラグインをクリックすると`Subscription`セクションが表示されます
2. Larkから取得した認証情報を入力します
![Lark Trigger Plugin](./_assets/8a92013e9ee55f32acc314ccbedb3ab5.png)
3. 注意：ここに表示される`Callback URL`をコピーし、ダイアログの下部までスクロールします。`REQUEST LOGS`は後で確認する必要があります。
4. Larkアプリ設定に移動し、`Events & Callbacks`セクションを見つけて、Request URLをDifyから取得した`Callback URL`に設定します。
![Lark Event Subscriptions](./_assets/6b5dc8dd7d5ff70e1af7b157d303c1ae.png)
5. 最後のステップとして、Larkアプリ設定を保存すると、テストリクエストがDifyワークスペースに送信されます。前述の`REQUEST LOGS`セクションでリクエストを確認できます。
![Lark Request Logs](./_assets/526273bed474a96720504f866ef82baf.png)
6. スクリーンショットは失敗例ですが、心配しないでください。手順を正しく実行すれば成功メッセージが表示されます。`create`ボタンをクリックして設定を保存してください。

### ステップ3：Difyワークフローで使用

適切なサブスクリプションとイベントを選択することを忘れないでください。

![Lark Trigger Plugin](./_assets/e8c150fb8d132270ed91cec395fe0d39.png)

## 利用可能なイベント

### メッセージ & チャット（IM）

#### メッセージ受信（`message_receive_v1`）

- **トリガー条件**: ボットが存在するチャットでの新しいメッセージ
- **取得できる情報**: メッセージ内容、送信者の詳細、チャット情報、メッセージタイプ
- **使用例**: 自動返信ボット、メッセージログ、キーワード検出

#### メッセージ既読（`message_read_v1`）

- **トリガー条件**: ユーザーがメッセージを読んだとき
- **取得できる情報**: 読者情報、メッセージID、既読タイムスタンプ
- **使用例**: 既読確認追跡、エンゲージメント分析

#### メッセージ取り消し（`message_recalled_v1`）

- **トリガー条件**: メッセージが撤回/取り消されたとき
- **取得できる情報**: 取り消されたメッセージID、取り消し時刻、操作者の詳細
- **使用例**: 監査証跡、コンプライアンス監視

#### メッセージリアクション追加（`message_reaction_added_v1`）

- **トリガー条件**: 誰かがメッセージに絵文字リアクションを追加したとき
- **取得できる情報**: リアクションタイプ、メッセージID、リアクター情報、アクション時刻
- **使用例**: センチメント分析、投票追跡、エンゲージメント指標

#### メッセージリアクション削除（`message_reaction_deleted_v1`）

- **トリガー条件**: 誰かが絵文字リアクションを削除したとき
- **取得できる情報**: 削除されたリアクションの詳細、メッセージID、操作者情報
- **使用例**: リアクション変更追跡、更新されたセンチメント分析

#### チャット更新（`chat_updated_v1`）

- **トリガー条件**: チャットグループ情報が変更されたとき
- **取得できる情報**: 更新されたチャットの詳細、変更タイプ、操作者情報
- **使用例**: グループ設定監視、コンプライアンス追跡

#### チャット解散（`chat_disbanded_v1`）

- **トリガー条件**: チャットグループが解散/削除されたとき
- **取得できる情報**: チャットID、解散時刻、操作者の詳細
- **使用例**: アーカイブ管理、クリーンアップワークフロー

#### チャットメンバーユーザー追加（`chat_member_user_added_v1`）

- **トリガー条件**: グループチャットにユーザーが追加されたとき
- **取得できる情報**: 新しいメンバーリスト、チャットの詳細、操作者情報
- **使用例**: ウェルカムメッセージ、アクセスプロビジョニング

#### チャットメンバーユーザー削除（`chat_member_user_removed_v1`）

- **トリガー条件**: グループチャットからユーザーが削除されたとき
- **取得できる情報**: 削除されたユーザーリスト、チャットの詳細、操作者情報
- **使用例**: アクセス取り消し、別れのメッセージ

#### チャットメンバーユーザー退出（`chat_member_user_withdrawn_v1`）

- **トリガー条件**: ユーザーが自発的にグループチャットを退出したとき
- **取得できる情報**: ユーザーの詳細、チャット情報、退出時刻
- **使用例**: 退出アンケート、メンバーシップ追跡

#### チャットメンバーボット追加（`chat_member_bot_added_v1`）

- **トリガー条件**: ボットがグループチャットに追加されたとき
- **取得できる情報**: ボットの詳細、チャット情報、操作者の詳細
- **使用例**: ボットの初期化、設定セットアップ

#### チャットメンバーボット削除（`chat_member_bot_deleted_v1`）

- **トリガー条件**: ボットがグループチャットから削除されたとき
- **取得できる情報**: ボットの詳細、チャット情報、操作者の詳細
- **使用例**: クリーンアップタスク、データアーカイブ

### ファイル & ドキュメント（Drive）

#### ファイル作成（`file_created_v1`）

- **トリガー条件**: 新しいファイルまたはドキュメントが作成されたとき
- **取得できる情報**: ファイルの詳細、作成者情報、ファイルタイプ、場所
- **使用例**: 自動分類、バックアップ作成

#### ファイル編集（`file_edit_v1`）

- **トリガー条件**: ファイルが編集されたとき
- **取得できる情報**: ファイルの詳細、編集者情報、編集タイムスタンプ
- **使用例**: バージョン追跡、変更通知

#### ファイル読み取り（`file_read_v1`）

- **トリガー条件**: ファイルがアクセスまたは閲覧されたとき
- **取得できる情報**: ファイルの詳細、読者情報、アクセス時刻
- **使用例**: アクセスログ、人気度追跡

#### ファイル削除（`file_deleted_v1`）

- **トリガー条件**: ファイルが削除されたとき
- **取得できる情報**: ファイルの詳細、削除操作者、削除時刻
- **使用例**: リカバリーワークフロー、監査ログ

#### ファイルゴミ箱移動（`file_trashed_v1`）

- **トリガー条件**: ファイルがゴミ箱に移動されたとき
- **取得できる情報**: ファイルの詳細、操作者情報、ゴミ箱移動時刻
- **使用例**: ゴミ箱監視、復元リマインダー

#### ファイルタイトル更新（`file_title_updated_v1`）

- **トリガー条件**: ファイルタイトルが更新されたとき
- **取得できる情報**: ファイルの詳細、更新者情報、新旧タイトル
- **使用例**: タイトル変更追跡、命名規則チェック
