# Airtable Trigger Plugin - Development Summary

## 项目概述

基于 Zendesk trigger 插件的结构，成功创建了一个新的 Airtable trigger 插件。该插件使用 Personal Access Token (API Token) 进行认证，不包含 OAuth 支持。

## 文件结构

```
triggers/airtable_trigger/
├── manifest.yaml                 # 插件清单配置
├── main.py                       # 插件入口点
├── requirements.txt              # Python 依赖
├── icon.svg                      # 插件图标
├── README.md                     # 详细文档（英文）
├── provider/
│   ├── airtable.yaml            # Provider 配置（凭证和参数定义）
│   └── airtable.py              # Provider 实现（webhook 管理）
├── events/
│   ├── __init__.py
│   ├── utils.py                 # 事件过滤工具函数
│   └── record/
│       ├── __init__.py
│       ├── record_created.yaml  # 记录创建事件配置
│       ├── record_created.py    # 记录创建事件处理
│       ├── record_updated.yaml  # 记录更新事件配置
│       ├── record_updated.py    # 记录更新事件处理
│       ├── record_deleted.yaml  # 记录删除事件配置
│       └── record_deleted.py    # 记录删除事件处理
├── readme/
│   ├── en_US.md                 # 英文简介
│   └── zh_Hans.md               # 中文简介
└── _assets/                      # 资源文件夹（预留）
```

## 核心功能

### 1. 认证方式
- **Personal Access Token**: 使用 Airtable 个人访问令牌
- **所需权限**:
  - `webhook:manage` - 创建和管理 webhook
  - `data.records:read` - 读取记录数据
  - `schema.bases:read` - 读取 base 架构

### 2. 支持的事件类型
- **record_created**: 记录创建时触发
- **record_updated**: 记录更新时触发
- **record_deleted**: 记录删除时触发

### 3. Webhook 管理功能
- **创建 webhook** (`_create_subscription`): 在 Airtable 中创建 webhook
- **删除 webhook** (`_delete_subscription`): 删除已创建的 webhook
- **刷新 webhook** (`_refresh_subscription`): 延长 webhook 7 天有效期
- **验证凭证** (`_validate_api_key`): 验证 Personal Access Token

### 4. 安全特性
- **HMAC 签名验证**: 可选的 MAC secret 用于验证 webhook 通知真实性
- **自动生成 secret**: 如果未提供，自动生成 MAC secret

### 5. 过滤功能
- **表格过滤**: 仅监控特定表格的变化
- **字段过滤**: 根据字段值和关键词过滤事件
- **变更字段过滤**: 仅在特定字段变更时触发（更新事件）

## 配置参数

### 必需参数
- `access_token`: Airtable Personal Access Token
- `base_id`: 要监控的 Base ID
- `events`: 要监控的事件类型（可多选）

### 可选参数
- `mac_secret`: HMAC 签名验证密钥（留空自动生成）
- `table_ids`: 要监控的表格 ID 列表（逗号分隔，留空监控所有表格）

### 事件特定过滤器
- `table_id`: 表格 ID 过滤
- `field_filter_name`: 字段名称
- `field_filter_keywords`: 字段关键词
- `changed_fields`: 变更字段过滤（仅更新事件）

## 技术实现细节

### Airtable Webhook 工作原理
1. **通知 Ping**: Airtable 发送轻量级通知，不包含实际数据
2. **Payload 获取**: 需要额外调用 API 获取实际变更数据
3. **有效期管理**: Personal Access Token 创建的 webhook 7 天后过期
4. **自动刷新**: 插件实现自动刷新功能延长有效期

### 关键类和方法

#### AirtableTrigger
- `_dispatch_event`: 处理接收到的 webhook 通知
- `_dispatch_trigger_events`: 根据 payload 分发事件
- `_validate_payload`: 验证 payload 和签名
- `_verify_signature`: HMAC 签名验证

#### AirtableSubscriptionConstructor
- `_validate_api_key`: 验证 Personal Access Token
- `_create_subscription`: 创建 Airtable webhook
- `_delete_subscription`: 删除 webhook
- `_refresh_subscription`: 刷新 webhook 延长有效期

## 注意事项

### 当前限制
1. **Payload 获取**: 事件处理器目前返回通知数据，实际应用中需要额外调用 API 获取完整 payload
2. **认证传递**: 事件处理器中无法直接访问 access_token，需要在生产环境中改进
3. **测试**: 需要实际的 Airtable 账户和 base 进行测试

### 生产环境建议
1. 实现完整的 payload 获取逻辑
2. 添加错误重试机制
3. 实现事务编号（transaction number）追踪避免重复处理
4. 添加详细的日志记录
5. 考虑添加 webhook 健康检查

## API 端点

### Airtable API 基础 URL
`https://api.airtable.com/v0`

### 使用的端点
- `POST /bases/{baseId}/webhooks` - 创建 webhook
- `DELETE /bases/{baseId}/webhooks/{webhookId}` - 删除 webhook
- `POST /bases/{baseId}/webhooks/{webhookId}/refresh` - 刷新 webhook
- `GET /meta/whoami` - 验证凭证

## 参考文档

- [Airtable Webhooks API](https://airtable.com/developers/web/api/webhooks-overview)
- [Airtable Authentication](https://airtable.com/developers/web/api/authentication)
- [Zendesk Trigger Plugin](https://github.com/langgenius/dify-official-plugins/tree/main/triggers/zendesk_trigger)

## 下一步

1. 实际测试插件功能
2. 完善 payload 获取逻辑
3. 添加单元测试
4. 优化错误处理
5. 考虑添加更多过滤选项
