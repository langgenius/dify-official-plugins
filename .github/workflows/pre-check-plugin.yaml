name: Pre Check Plugin

on:
  pull_request:
    types: [opened, synchronize, ready_for_review, review_requested, edited]
    branches:
      - main
    paths:
      - "agent-strategies/**"
      - "datasources/**"
      - "extensions/**"
      - "models/**"
      - "tools/**"
      - "triggers/**"

env:
  REPO_NAME: langgenius/dify-official-plugins
  MARKETPLACE_BASE_URL: https://marketplace.dify.ai
  MARKETPLACE_TOKEN: placeholder
  GH_TOKEN: ${{ github.token }}

jobs:
  pre-check-plugin:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Clone Marketplace Toolkit
        run: |
          gh repo clone langgenius/dify-marketplace-toolkit -- .scripts/

      - name: Download Plugin Daemon
        run: |
          gh release download -R langgenius/dify-plugin-daemon --pattern "dify-plugin-linux-amd64" --dir .scripts || gh release download -R langgenius/dify-plugin-daemon --pattern "dify-plugin-linux-amd64" --dir .scripts
          chmod +x .scripts/dify-plugin-linux-amd64
          mv .scripts/dify-plugin-linux-amd64 /usr/local/bin/dify

      - name: Setup uv
        uses: astral-sh/setup-uv@v6
        with:
          version: "latest"
          activate-environment: false

      - name: Setup Global Python
        run: |
          uv venv --python 3.12.7
          uv pip install requests dify_plugin pytest

      - name: yq - portable yaml processor
        uses: mikefarah/yq@v4.44.5

      - name: Get PR Path
        run: |
          # 1. Get files excluding tests
          export PR_FILES_NO_TESTS=$(gh pr view -R ${{ env.REPO_NAME }} ${{ github.event.pull_request.number }} --json files --jq '.files | map(select(.path | startswith("tests/") | not))')
          
          # 2. Check if we have standard plugin files
          if [ "$(echo $PR_FILES_NO_TESTS | jq 'length')" -gt "0" ]; then
              export PR_FILES=$PR_FILES_NO_TESTS
              if PLUGIN_PATH=$(uv run python .scripts/validator/check-prefix.py); then
                  echo $PLUGIN_PATH
                  echo "PLUGIN_PATH=$PLUGIN_PATH" >> $GITHUB_ENV
              else
                  echo "PR files cross different plugin directories, skip upload."
                  exit 1
              fi
          else
              # 3. No plugin files, check if we have test files only
              # Exclude __mockserver from detection to avoid inferring it as a plugin path
              ALL_FILES=$(gh pr view -R ${{ env.REPO_NAME }} ${{ github.event.pull_request.number }} --json files --jq '.files | map(select(.path | contains("__mockserver") | not))')
              if [ "$(echo $ALL_FILES | jq 'length')" -gt "0" ]; then
                  # Infer path from the first file, assuming all belong to same plugin if simple test change
                  FIRST_FILE=$(echo $ALL_FILES | jq -r '.[0].path')
                  if [[ $FIRST_FILE == tests/* ]]; then
                       # Remove tests/ prefix and get first two path components (e.g., tests/models/openai -> models/openai)
                       # Logic: remove "tests/", then take field 1 and 2
                       REL_PATH=${FIRST_FILE#tests/}
                       PLUGIN_PATH=$(echo $REL_PATH | cut -d/ -f1,2)
                       
                       echo "Detected test-only change for $PLUGIN_PATH"
                       echo "PLUGIN_PATH=$PLUGIN_PATH" >> $GITHUB_ENV
                       echo "SKIP_CHECKS=true" >> $GITHUB_ENV
                  else
                       echo "Unknown file modification pattern."
                       exit 1
                  fi
              else
                  echo "No relevant files found (or only mockserver files changed)."
                  exit 0
              fi
          fi

      - name: Check Plugin Manifest
        if: env.SKIP_CHECKS != 'true'
        run: |
          # manifest.yaml author must be langgenius
          if ! yq '.author' ${{ env.PLUGIN_PATH }}/manifest.yaml | grep -q "langgenius"; then
            echo "!!! Plugin manifest.yaml author must be langgenius"
            exit 1
          fi

      - name: Check for Disallowed Virtualenv Directories
        if: env.SKIP_CHECKS != 'true'
        run: |
          if find "${{ env.PLUGIN_PATH }}" -maxdepth 1 -type d \( -name ".venv*" -o -name "venv*" \) | grep -q .; then
            echo "!!! Please remove .venv or venv* directory in plugin path before submitting the PR"
            exit 1
          fi

      - name: Check If Version Exists
        if: env.SKIP_CHECKS != 'true'
        run: |
          # get version, author, name
          VERSION=$(yq '.version' ${{ env.PLUGIN_PATH }}/manifest.yaml)
          AUTHOR=$(yq '.author' ${{ env.PLUGIN_PATH }}/manifest.yaml)
          NAME=$(yq '.name' ${{ env.PLUGIN_PATH }}/manifest.yaml)
          echo "Checking plugin version: $VERSION"

          # Check if the version already exists
          RESPONSE_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${{ env.MARKETPLACE_BASE_URL }}/api/v1/plugins/$AUTHOR/$NAME/$VERSION")

          if [ "$RESPONSE_CODE" = "200" ]; then
            RESPONSE=$(curl -s "${{ env.MARKETPLACE_BASE_URL }}/api/v1/plugins/$AUTHOR/$NAME/$VERSION")
            if [ "$(echo "$RESPONSE" | jq -r '.code')" = "0" ]; then
              echo "!!! Plugin version $VERSION already exists, please update the version number in manifest.yaml"
              exit 1
            fi
          fi

      - name: Test Changed Plugin
        run: |
          if [ -d "tests/${{ env.PLUGIN_PATH }}" ]; then
            if [ -f "tests/${{ env.PLUGIN_PATH }}/requirements.txt" ]; then
              uv pip install -r tests/${{ env.PLUGIN_PATH }}/requirements.txt
            fi
            PYTHONPATH=. uv run pytest tests/${{ env.PLUGIN_PATH }}
          fi

      - name: Check Plugin Install
        if: env.SKIP_CHECKS != 'true'
        run: |
          cd ${{ env.PLUGIN_PATH }}
          if [ -f requirements.txt ]; then
              uv pip install -r requirements.txt
              export INSTALL_METHOD=serverless
              export SERVERLESS_PORT=8080
              export SERVERLESS_HOST=0.0.0.0
          fi
          cd -
          uv run python .scripts/validator/test-plugin-install.py -d ${{ env.PLUGIN_PATH }}
      
      - name: Clean Venv Created by uv
        run: |
          cd ${{ env.PLUGIN_PATH }}
          rm -rf .venv

      - name: Check Packaging
        if: env.SKIP_CHECKS != 'true'
        run: |
          uv run python .scripts/uploader/upload-package.py -d ${{ env.PLUGIN_PATH }} -t ${{ env.MARKETPLACE_TOKEN }} --plugin-daemon-path /usr/local/bin/dify -u ${{ env.MARKETPLACE_BASE_URL }} -f --test
